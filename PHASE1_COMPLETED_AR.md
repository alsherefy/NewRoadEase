# ุงูุชูุงู ุงููุฑุญูุฉ ุงูุฃููู - ูุธุงู ุงููุตุงุฏูุฉ ูุงูุตูุงุญูุงุช ุงูููุญุฏ

## โ ูุง ุชู ุฅูุฌุงุฒู

### 1. ูุธุงู ุงููุตุงุฏูุฉ ุงูููุญุฏ (`authWithPermissions.ts`)

ุชู ุฅูุดุงุก ูุธุงู ูุฑูุฒู ูููุตุงุฏูุฉ ูููู ุจู:
- ุงูุชุญูู ูู ุงููุณุชุฎุฏู ุนุจุฑ JWT token
- ุชุญููู ูุนูููุงุช ุงููุณุชุฎุฏู ู organization ID
- ุฌูุจ ุฃุฏูุงุฑ ุงููุณุชุฎุฏู
- **ุชุญููู ุฌููุน ุงูุตูุงุญูุงุช ุงูุชูุตูููุฉ ุฏูุนุฉ ูุงุญุฏุฉ** (ูุซู `expenses.create`, `expenses.update`)
- ุฅุฑุฌุงุน `AuthContext` ูุงูู ุจูู ุงููุนูููุงุช ุงููุทููุจุฉ
- ุฅุฒุงูุฉ ุงูุงุณุชุฏุนุงุกุงุช ุงููุชูุฑุฑุฉ ููุงุนุฏุฉ ุงูุจูุงูุงุช

**ุงููููุน:** `/supabase/functions/_shared/middleware/authWithPermissions.ts`

**ุงูููุงุฆุฏ:**
- ูุตุฏุฑ ูุงุญุฏ ููุญูููุฉ ูู ุงููุตุงุฏูุฉ
- ุงุณุชุฏุนุงุก ูุงุญุฏ ููุงุนุฏุฉ ุงูุจูุงูุงุช ุจุฏูุงู ูู 3-4 ุงุณุชุฏุนุงุกุงุช ูููุตูุฉ
- ุณูุงู ูุตุงุฏูุฉ ูุชุณู ุนุจุฑ ุฌููุน Edge Functions
- ุฃุณูู ูู ุงูุตูุงูุฉ ูุงูุชุตุญูุญ

---

### 2. ุฃุฏุงุฉ ูุญุต ุงูุตูุงุญูุงุช (`permissionChecker.ts`)

ุชู ุฅูุดุงุก ูุธุงู ุดุงูู ููุญุต ุงูุตูุงุญูุงุช ูุน:
- `requirePermission(auth, 'permission.key')` - ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ ููุฑุถ ุงูุตูุงุญูุงุช
- `hasPermission(auth, 'permission.key')` - ูุญุต ุจุฏูู ุฑูู ุฎุทุฃ
- `requireAnyPermission()` ู `requireAllPermissions()` - ูุญูุตุงุช ูุชูุฏูุฉ
- **ุฑุณุงุฆู ุฎุทุฃ ุจุงูุนุฑุจูุฉ ูุงูุฅูุฌููุฒูุฉ**
- ุงููุฏุฑุงุก ูุชุฌุงูุฒูู ุฌููุน ูุญูุตุงุช ุงูุตูุงุญูุงุช ุชููุงุฆูุงู

**ุงููููุน:** `/supabase/functions/_shared/middleware/permissionChecker.ts`

**ุงูููุงุฆุฏ:**
- ูุญูุตุงุช ุตูุงุญูุงุช ูุงุถุญุฉ ูุณููุฉ ุงููุฑุงุกุฉ
- ุฑุณุงุฆู ุฎุทุฃ ูููููุฉ ูููุณุชุฎุฏู
- ูุง ูุฒูุฏ ูู ุงูุงุฑุชุจุงู ุจูู `isAdmin` ู `canEdit`
- ุชุญูู ุฏููู ุจุงูุตูุงุญูุงุช (ุนุฑุถุ ุฅูุดุงุกุ ุชุนุฏููุ ุญุฐู)

---

### 3. ุชุญุฏูุซ Edge Functions

**ุชู ุชุญุฏูุซ Edge Functions ุงูุญุฑุฌุฉ ุงูุชุงููุฉ ูุงุณุชุฎุฏุงู ุงููุธุงู ุงูุฌุฏูุฏ:**

#### โ Expenses (ุงููุตุฑููุงุช)
- **ูุจู:** ูุงู ูุณุชุฎุฏู ูุญุต `isAdmin` ููุท
- **ุจุนุฏ:** ูุณุชุฎุฏู ุตูุงุญูุงุช ุชูุตูููุฉ:
  - `expenses.view` ูููุฑุงุกุฉ (GET)
  - `expenses.create` ููุฅูุดุงุก (POST)
  - `expenses.update` ููุชุนุฏูู (PUT)
  - `expenses.delete` ููุญุฐู (DELETE)

#### โ Work Orders (ุฃูุงูุฑ ุงูุนูู)
- **ูุจู:** ูุงู ูุณุชุฎุฏู `canEdit` ู `isAdmin`
- **ุจุนุฏ:** ูุณุชุฎุฏู ุตูุงุญูุงุช ุชูุตูููุฉ:
  - `work_orders.view` ูููุฑุงุกุฉ
  - `work_orders.create` ููุฅูุดุงุก
  - `work_orders.update` ููุชุนุฏูู
  - `work_orders.delete` ููุญุฐู

#### โ Inventory (ุงููุฎุฒูู)
- **ูุจู:** ูุงู ูุณุชุฎุฏู ูุญูุตุงุช ุฃุฏูุงุฑ ูุฎุชูุทุฉ
- **ุจุนุฏ:** ูุณุชุฎุฏู ุตูุงุญูุงุช ุชูุตูููุฉ:
  - `inventory.view` ูููุฑุงุกุฉ
  - `inventory.create` ููุฅูุดุงุก
  - `inventory.update` ููุชุนุฏูู
  - `inventory.delete` ููุญุฐู

#### โ Invoices (ุงูููุงุชูุฑ)
- **ูุจู:** ูุงู ูุณุชุฎุฏู ูุญูุตุงุช ูุนูุฏุฉ ูุน `adminAndCustomerService`, `adminOnly`
- **ุจุนุฏ:** ูุญูุตุงุช ุตูุงุญูุงุช ูุธููุฉ:
  - `invoices.view` ูููุฑุงุกุฉ
  - `invoices.create` ููุฅูุดุงุก
  - `invoices.update` ุฃู `invoices.manage_payments` ููุชุนุฏูู (ููุทู ุฐูู ูุชุญุฏูุซุงุช ุงูุฏูุน ููุท)
  - `invoices.delete` ููุญุฐู

#### โ Customers (ุงูุนููุงุก)
- **ูุจู:** ูุงู ูุณุชุฎุฏู `canEdit` ู `isAdmin`
- **ุจุนุฏ:** ูุณุชุฎุฏู ุตูุงุญูุงุช ุชูุตูููุฉ:
  - `customers.view` ูููุฑุงุกุฉ
  - `customers.create` ููุฅูุดุงุก
  - `customers.update` ููุชุนุฏูู
  - `customers.delete` ููุญุฐู

---

## ๐ง ุชุญุณููุงุช ุฌูุฏุฉ ุงูููุฏ

1. **ุฅุฒุงูุฉ ุฌููุน ุงุณุชุฏุนุงุกุงุช `console.error()`** ูู ููุฏ ุงูุฅูุชุงุฌ
2. **ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก** ูุน ุงูุชูุงุท ุตุญูุญ ูู ApiError
3. **ุฅุฒุงูุฉ ููุทู ุงููุตุงุฏูุฉ ุงูููุฑุฑ** ุนุจุฑ Edge Functions
4. **ุชูุญูุฏ ุตูุบุฉ ุงูุฑุฏูุฏ** ุนุจุฑ ุฌููุน ุงูุฏูุงู

---

## ๐ฏ ุงููุชุงุฆุฌ ุงููุชููุนุฉ

### ูุธุงู ุงูุตูุงุญูุงุช
โ ุงูุตูุงุญูุงุช ุชุนูู ุงูุขู ุจุดูู ุตุญูุญ ุญุณุจ ุฅุนุฏุงุฏุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช
โ ูุชู ูุฑุถ ููุงุชูุญ ุงูุตูุงุญูุงุช ุงูุชูุตูููุฉ (ูุซู `expenses.create`)
โ ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ ุนูุฏ ุฑูุถ ุงูุตูุงุญูุงุช
โ ุงููุฏุฑุงุก ูุฏููู ูุตูู ูุงูู ููู ุดูุก

### ุงูุฃุฏุงุก
โ ุชูููู ุงุณุชุฏุนุงุกุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช ููู ุทูุจ (ูู 3-4 ุฅูู 1)
โ ูุตุงุฏูุฉ ุฃุณุฑุน (ุงุณุชุฏุนุงุก ููุญุฏ ูุงุญุฏ)
โ ููุฏ ุฃูุธู ูุฃุณูู ูู ุงูุตูุงูุฉ

### ุชุฌุฑุจุฉ ุงููุทูุฑ
โ ุฃุณูู ูุฅุถุงูุฉ ุตูุงุญูุงุช ุฌุฏูุฏุฉ
โ ุฃููุงุท ูุชุณูุฉ ุนุจุฑ ุฌููุน Edge Functions
โ ุฑุณุงุฆู ุฎุทุฃ ุฃูุถู ููุชุตุญูุญ

---

## ๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ (ุงููุฑุญูุฉ ุงูุซุงููุฉ)

ุงูุนูุงุตุฑ ุงูุชุงููุฉ ูู ุงูุฎุทุฉ ุงูุฃุตููุฉ **ุฌุงูุฒุฉ ููุชูููุฐ:**

### ุงูุฃููููุฉ 1: ุฅููุงู ุชุญุฏูุซ Edge Functions
- ุชุญุฏูุซ Edge Functions ุงููุชุจููุฉ (users, technicians, salaries, ุฅูุฎ)
- ุงุชุจุงุน ููุณ ุงูููุท ุงููุณุชุฎุฏู ูู ุงููุฑุญูุฉ ุงูุฃููู

### ุงูุฃููููุฉ 2: ุฏูุฌ Frontend
- ุฅุฒุงูุฉ ุงุณุชุฏุนุงุกุงุช Supabase ุงููุจุงุดุฑุฉ ูู ููููุงุช React
- ุฅุฌุจุงุฑ ุฌููุน ุนูููุงุช ุงูุจูุงูุงุช ุนูู ุงููุฑูุฑ ุนุจุฑ Edge Functions
- ุชุญุฏูุซ WorkOrderDetails.tsx, Customers.tsx, ุฅูุฎ

### ุงูุฃููููุฉ 3: ุชุญุณูู ุฃุฏุงุก ูุงุนุฏุฉ ุงูุจูุงูุงุช
- ุฅูุดุงุก materialized view ูู `get_user_all_permissions`
- ุฅุถุงูุฉ ูุชุบูุฑุงุช ุฌูุณุฉ ูุชุญุณูู RLS
- ุฅูุดุงุก indexes ูุฑูุจุฉ ุฅุถุงููุฉ

### ุงูุฃููููุฉ 4: ุชูููุฐ ุงูู Caching
- ุฅุถุงูุฉ caching ูุตูุงุญูุงุช ุงููุณุชุฎุฏู ูู AuthContext
- ุชุฎุฒูู ูุคูุช ููุจูุงูุงุช ุงูุซุงุจุชุฉ (ูุงุฆูุฉ ุงูุนููุงุกุ ูุงุฆูุฉ ุงูููููู)
- ุชูููุฐ ุงุณุชุฑุงุชูุฌูุฉ ุฅูุบุงุก ุงูู cache

### ุงูุฃููููุฉ 5: ุฃุฏุงุก Frontend
- ุฅุถุงูุฉ useMemo ููุญุณุงุจุงุช ุงูููููุฉ
- ุฅุถุงูุฉ useCallback ููุนุงูุฌุงุช ุงูุฃุญุฏุงุซ
- ุชูููุฐ debouncing ูุญููู ุงูุจุญุซ
- ุฅุตูุงุญ N+1 queries ูู NewWorkOrder.tsx

---

## ๐ ููููุฉ ุงูุงุฎุชุจุงุฑ

1. **ุงุฎุชุจุงุฑ ุฃุฏูุงุฑ ุงููุณุชุฎุฏููู ุงููุฎุชููุฉ:**
   - ุชุณุฌูู ุฏุฎูู ูู Admin โ ูุฌุจ ุฃู ูููู ูู ุงูุตูุงุญูุงุช
   - ุชุณุฌูู ุฏุฎูู ูู Customer Service โ ูุฌุจ ุฃู ูููู ุตูุงุญูุงุช ูุญุฏูุฏุฉ
   - ุชุณุฌูู ุฏุฎูู ูู Receptionist โ ูุฌุจ ุฃู ูููู ุตูุงุญูุงุช ูุญุฏูุฏุฉ ุฌุฏุงู

2. **ุงุฎุชุจุงุฑ ุฑูุถ ุงูุตูุงุญูุงุช:**
   - ูุญุงููุฉ ุฅูุดุงุก ูุตุฑูู ุจุฏูู ุตูุงุญูุฉ `expenses.create`
   - ูุญุงููุฉ ุญุฐู ูุงุชูุฑุฉ ุจุฏูู ุตูุงุญูุฉ `invoices.delete`
   - ุงูุชุญูู ูู ุฃู ุฑุณุงุฆู ุงูุฎุทุฃ ูุงุถุญุฉ ุจุงูุนุฑุจูุฉ ูุงูุฅูุฌููุฒูุฉ

3. **ุงุฎุชุจุงุฑ ุงูุฃุฏุงุก:**
   - ูุญุต ุชุจููุจ Network โ ุงููุตุงุฏูุฉ ูุฌุจ ุฃู ุชููู ุงุณุชุฏุนุงุก ูุงุญุฏ
   - Edge functions ูุฌุจ ุฃู ุชุณุชุฌูุจ ุจุดูู ุฃุณุฑุน
   - ูุง ูุญูุตุงุช ุตูุงุญูุงุช ูุชูุฑุฑุฉ

---

## ๐ ููุงุญุธุงุช ุชูููุฉ

### ุตูุบุฉ ููุชุงุญ ุงูุตูุงุญูุฉ
ุฌููุน ุงูุตูุงุญูุงุช ุชุชุจุน ุงูุตูุบุฉ: `resource.action`

ุฃูุซูุฉ:
- `expenses.view`
- `expenses.create`
- `expenses.update`
- `expenses.delete`
- `invoices.manage_payments` (ุญุงูุฉ ุฎุงุตุฉ)

### ุจููุฉ AuthContext
```typescript
interface AuthContext {
  userId: string;
  organizationId: string;
  email: string;
  fullName: string;
  isActive: boolean;
  roles: Role[];
  isAdmin: boolean;
  permissions: string[]; // ูุตูููุฉ ูู ููุงุชูุญ ุงูุตูุงุญูุงุช
}
```

### ุงูุงุณุชุฎุฏุงู ูู Edge Functions
```typescript
// ุงููุตุงุฏูุฉ
const auth = await authenticateWithPermissions(req);

// ูุญุต ุงูุตูุงุญูุฉ
requirePermission(auth, 'expenses.create');

// ุงุฎุชูุงุฑู: ูุญุต ุจุฏูู ุฑูู ุฎุทุฃ
if (hasPermission(auth, 'invoices.update')) {
  // ูู ุจุดูุก ูุง
}
```

---

## โจ ุงูููุฎุต

**ุงููุฑุญูุฉ ุงูุฃููู ููุชููุฉ!** ุชู ุฅุนุงุฏุฉ ุจูุงุก ูุธุงู ุงููุตุงุฏูุฉ ูุงูุตูุงุญูุงุช ุจุงููุงูู ูุน:
- Middleware ููุญุฏ ูุฌููุน Edge Functions
- ูุญุต ุตูุงุญูุงุช ุชูุตููู ูุน ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ
- 5 Edge Functions ุญุฑุฌุฉ ูุญุฏุซุฉ ููุฎุชุจุฑุฉ
- ุชุญุณููุงุช ุฌูุฏุฉ ุงูููุฏ ูู ูู ููุงู
- ุงุฎุชุจุงุฑ ุงูุจูุงุก ูุงุฌุญ โ

ุงููุธุงู ุงูุขู ุฌุงูุฒ ูุชูููุฐ ุงููุฑุญูุฉ ุงูุซุงููุฉ!
