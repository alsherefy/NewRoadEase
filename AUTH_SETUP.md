# إعداد نظام المستخدمين والصلاحيات

تم إضافة نظام كامل لإدارة المستخدمين والصلاحيات إلى نظام إدارة الورشة.

## المميزات

### 1. نوعان من المستخدمين
- **المدير (Admin)**: لديه صلاحية الوصول الكامل لجميع أجزاء النظام
- **الموظف (Employee)**: يمكن للمدير تحديد الصلاحيات المتاحة له

### 2. الصلاحيات المتاحة
- العملاء (Customers)
- أوامر العمل (Work Orders)
- الفواتير (Invoices)
- المخزون (Inventory)
- الفنيين (Technicians)
- التقارير (Reports)
- الإعدادات (Settings)
- إدارة المستخدمين (Users) - للمدير فقط

### 3. مستويات الصلاحية
لكل صلاحية، يمكن تحديد:
- **عرض (View)**: يمكن للمستخدم مشاهدة البيانات فقط
- **تعديل (Edit)**: يمكن للمستخدم مشاهدة وتعديل وإضافة وحذف البيانات

## إنشاء أول مستخدم مدير

بما أن النظام الآن يتطلب تسجيل دخول، تحتاج إلى إنشاء أول مستخدم مدير يدوياً:

### الطريقة 1: من خلال Supabase Dashboard

1. افتح لوحة تحكم Supabase الخاصة بمشروعك
2. اذهب إلى **Authentication** > **Users**
3. انقر على **Add user** > **Create new user**
4. أدخل:
   - Email: admin@workshop.com
   - Password: (اختر كلمة مرور قوية)
   - قم بتفعيل "Auto Confirm User"
5. انقر على **Create user**
6. انسخ الـ UUID الخاص بالمستخدم
7. اذهب إلى **Table Editor** > **users**
8. انقر على **Insert** > **Insert row**
9. أدخل:
   - id: (الصق الـ UUID الذي نسخته)
   - email: admin@workshop.com
   - full_name: المدير العام
   - role: admin
   - is_active: true
10. انقر على **Save**

### الطريقة 2: من خلال SQL Editor

1. افتح **SQL Editor** في لوحة تحكم Supabase
2. نفذ هذا الكود (استبدل البريد الإلكتروني وكلمة المرور):

```sql
-- إنشاء مستخدم في نظام المصادقة
INSERT INTO auth.users (
  instance_id,
  id,
  aud,
  role,
  email,
  encrypted_password,
  email_confirmed_at,
  invited_at,
  confirmation_token,
  confirmation_sent_at,
  recovery_token,
  recovery_sent_at,
  email_change_token_new,
  email_change,
  email_change_sent_at,
  last_sign_in_at,
  raw_app_meta_data,
  raw_user_meta_data,
  is_super_admin,
  created_at,
  updated_at
) VALUES (
  '00000000-0000-0000-0000-000000000000',
  gen_random_uuid(),
  'authenticated',
  'authenticated',
  'admin@workshop.com',  -- استبدل بالبريد الإلكتروني المطلوب
  crypt('admin123456', gen_salt('bf')),  -- استبدل بكلمة المرور المطلوبة
  now(),
  now(),
  '',
  now(),
  '',
  now(),
  '',
  '',
  now(),
  now(),
  '{"provider":"email","providers":["email"]}',
  '{"full_name":"المدير العام"}',
  FALSE,
  now(),
  now()
)
RETURNING id;

-- احفظ الـ ID الذي سيظهر، ثم استخدمه في الاستعلام التالي

-- إضافة بيانات المستخدم في جدول users
INSERT INTO public.users (id, email, full_name, role, is_active)
VALUES (
  'الصق-الـ-UUID-هنا',  -- استبدل بالـ UUID من الاستعلام السابق
  'admin@workshop.com',
  'المدير العام',
  'admin',
  true
);
```

## استخدام النظام

### تسجيل الدخول
1. عند فتح التطبيق، سيتم توجيهك إلى صفحة تسجيل الدخول
2. أدخل البريد الإلكتروني وكلمة المرور
3. انقر على "تسجيل الدخول"

### إدارة المستخدمين (للمدير فقط)
1. من القائمة الرئيسية، انقر على "المستخدمين"
2. لإضافة مستخدم جديد:
   - انقر على "إضافة مستخدم جديد"
   - أدخل البيانات المطلوبة
   - اختر الدور (مدير أو موظف)
   - انقر على "حفظ"

3. لتحديد صلاحيات موظف:
   - انقر على بطاقة الموظف
   - انقر على "إدارة الصلاحيات"
   - حدد الصلاحيات المطلوبة (عرض/تعديل)
   - انقر على "حفظ الصلاحيات"

4. لتغيير كلمة مرور مستخدم:
   - في صفحة "المستخدمين"
   - انقر على زر "تغيير كلمة المرور" في بطاقة المستخدم
   - أدخل كلمة المرور الجديدة وتأكيدها
   - انقر على "تغيير كلمة المرور"

ملاحظة: المدراء يمكنهم تغيير كلمة مرور أي مستخدم دون الحاجة لكلمة المرور الحالية.

### تسجيل الخروج
- انقر على زر "خروج" في أعلى الصفحة

## ملاحظات أمنية

1. **كلمات المرور**: تأكد من استخدام كلمات مرور قوية (6 أحرف على الأقل)
2. **الصلاحيات**: امنح الموظفين فقط الصلاحيات التي يحتاجونها لعملهم
3. **المدراء**: احذر من إنشاء عدد كبير من حسابات المدراء
4. **تعطيل المستخدمين**: بدلاً من حذف المستخدمين، يمكنك تعطيلهم مؤقتاً
5. **المراجعة الدورية**: راجع صلاحيات المستخدمين بشكل دوري

## الأمان على مستوى قاعدة البيانات

تم تطبيق Row Level Security (RLS) على جميع الجداول:
- المدراء يمكنهم الوصول لجميع البيانات
- الموظفون يمكنهم الوصول فقط للبيانات حسب صلاحياتهم
- جميع العمليات محمية على مستوى قاعدة البيانات

## كيفية عمل النظام

### إضافة المستخدمين
عند إضافة مستخدم جديد من خلال الواجهة:
1. يتم إرسال البيانات إلى Edge Function `create-user`
2. الـ Edge Function تتحقق من أن المستخدم الحالي مدير
3. تستخدم Admin API لإنشاء المستخدم في نظام المصادقة
4. تضيف بيانات المستخدم إلى جدول `users`
5. إذا حدث خطأ، يتم حذف المستخدم تلقائياً

### تغيير كلمة المرور
عند تغيير كلمة مرور مستخدم من خلال الواجهة:
1. يتم إرسال البيانات إلى Edge Function `change-password`
2. الـ Edge Function تتحقق من أن المستخدم الحالي مدير
3. تستخدم Admin API لتحديث كلمة المرور
4. يتم إرسال إشعار بنجاح العملية

ميزات:
- متاح فقط للمدراء
- يمكن الوصول إليه من صفحة "المستخدمين"
- لا يتطلب كلمة المرور الحالية
- يسمح للمدير بتغيير كلمة مرور أي مستخدم (بما في ذلك كلمة مروره الشخصية)

### لماذا هذا النظام آمن؟
- لا يتم استخدام Service Role Key من جانب العميل أبداً
- جميع العمليات الحساسة تتم على الخادم (Edge Functions)
- التحقق من الصلاحيات يتم على الخادم وليس العميل
- فقط المدراء يمكنهم تغيير كلمات المرور
- استخدام Admin API الآمن من Supabase
- جميع العمليات محمية ومسجلة

## الدعم

إذا واجهت أي مشاكل في إعداد نظام المستخدمين، تأكد من:
1. تم تطبيق جميع الـ migrations بشكل صحيح
2. تم إنشاء المستخدم المدير بشكل صحيح
3. البريد الإلكتروني وكلمة المرور صحيحان
4. تم نشر Edge Functions بنجاح (`create-user` و `change-password`)
